<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/apt/examples/integration-tests.apt.vm at 2024-01-06
 | Rendered using Apache Maven Fluido Skin 1.11.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <meta name="author" content="Stephen Connolly" />
    <meta name="date" content="2011-01-17" />
    <title>Mojo's Cassandra Maven Plugin &#x2013; Integration tests</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.11.1.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.11.1.min.js"></script>

    <!-- Matomo -->
    <script>
        var _paq = window._paq = window._paq || [];
                _paq.push(['disableCookies']);
                    _paq.push(['trackPageView']);
                    _paq.push(['enableLinkTracking']);
        
        (function() {
            var u="https://analytics.apache.org/";
            _paq.push(['setTrackerUrl', u+'/matomo.php']);
            _paq.push(['setSiteId', '18']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src=u+'/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
    </script>
    <!-- End Matomo Code -->
    <style>.github-fork-ribbon:before { background-color: gray; }</style>
  </head>
  <body class="topBarDisabled">
    <a class="github-fork-ribbon right-top" href="https://github.com/mojohaus/cassandra-maven-plugin" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="../../" id="bannerLeft"><img src="../../images/mojo_logo.png"  alt="MojoHaus" style="" /></a></div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
      <li class=""><a href="../../" title="MojoHaus">MojoHaus</a><span class="divider">/</span></li>
      <li class=""><a href="../../mojo-parent" title="MojoHaus Parent">MojoHaus Parent</a><span class="divider">/</span></li>
      <li class=""><a href="../index.html" title="Mojo's Cassandra Maven Plugin">Mojo's Cassandra Maven Plugin</a><span class="divider">/</span></li>
    <li class="active ">Integration tests <a href="https://github.com/mojohaus/cassandra-maven-plugin/src/site/apt/examples/integration-tests.apt.vm"><img src="../images/accessories-text-editor.png" title="Edit" /></a></li>
        <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2024-01-06</li>
          <li id="projectVersion" class="pull-right"><span class="divider">|</span>Version: 3.8</li>
        <li class="pull-right"><a href="https://maven.apache.org/" class="externalLink" title="Maven">Maven</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Overview</li>
    <li><a href="../index.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="../plugin-info.html" title="Goals"><span class="none"></span>Goals</a></li>
    <li><a href="../usage.html" title="Usage"><span class="none"></span>Usage</a></li>
   <li class="nav-header">Examples</li>
    <li><a href="../examples/developing-webapp.html" title="Developing a web application"><span class="none"></span>Developing a web application</a></li>
    <li class="active"><a><span class="none"></span>Integration tests</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<section>
<h2><a name="Integration_tests"></a>Integration tests</h2>
<p>The aim here is to combine the usage of the <code>cassandra-maven-plugin</code> with the <code>maven-failsafe-plugin</code> to allow the integration tests to be run against a test instance of Apache Cassandra. The developer does not have to manually install Cassandra.</p>
<p>First we need to modify the <code>pom.xml</code> to reference both <code>cassandra-maven-plugin</code> and the <code>maven-failsafe-plugin</code></p>
<div>
<pre>&lt;project&gt;
  ...
  &lt;build&gt;
    ...
    &lt;plugins&gt;
      ...
      &lt;plugin&gt;
        &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.7.1&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;integration-test&lt;/goal&gt;
              &lt;goal&gt;verify&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
        &lt;artifactId&gt;cassandra-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;3.8&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;start&lt;/goal&gt;
              &lt;goal&gt;stop&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      ...
    &lt;/plugins&gt;
    ...
  &lt;/build&gt;
  ...
&lt;/project&gt;</pre></div>
<p>This will result in the following mojos being executed during the lifecycle as follows:</p>
<table border="1" class="table table-striped">
<tr class="a">
<td align="left"><b>Phase</b></td>
<td align="left"><b>Goal(s)</b></td></tr>
<tr class="b">
<td align="left">pre-integration-test</td>
<td align="left">cassandra:start</td></tr>
<tr class="a">
<td align="left">integration-test</td>
<td align="left">failsafe:integration-test</td></tr>
<tr class="b">
<td align="left">post-integration-test</td>
<td align="left">cassandra:stop</td></tr>
<tr class="a">
<td align="left">verify</td>
<td align="left">failsafe:verify</td></tr></table>
<p>If you want the tests to be more independent, you can leverage the <code>build-helper-maven-plugin</code> to allocate random ports to your tests, thereby ensuring that the tests don't fail if a port is in use, and allowing, e.g. parallel builds on a build server.</p>
<p>For example (Note this example assumes you use resource filtering to pass the cassandra ports through to the tests, you could also pass them through as system properties by configuring <code>maven-failsafe-plugin</code>):</p>
<div>
<pre>&lt;project&gt;
  ...
  &lt;build&gt;
    ...
    &lt;plugins&gt;
      ...
      &lt;plugin&gt;
        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
        &lt;artifactId&gt;build-helper-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.5&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;id&gt;reserve-network-port&lt;/id&gt;
            &lt;goals&gt;
              &lt;goal&gt;reserve-network-port&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;phase&gt;process-test-resources&lt;/phase&gt;
            &lt;configuration&gt;
              &lt;portNames&gt;
                &lt;portName&gt;cassandra.rpcPort&lt;/portName&gt;
                &lt;portName&gt;cassandra.jmxPort&lt;/portName&gt;
                &lt;portName&gt;cassandra.storagePort&lt;/portName&gt;
              &lt;/portNames&gt;
            &lt;/configuration&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.7.1&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;integration-test&lt;/goal&gt;
              &lt;goal&gt;verify&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
        &lt;artifactId&gt;cassandra-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;3.8&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;start&lt;/goal&gt;
              &lt;goal&gt;stop&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      ...
    &lt;/plugins&gt;
    ...
  &lt;/build&gt;
  ...
&lt;/project&gt;</pre></div><section>
<h3><a name="Local_clusters"></a>Local clusters</h3>
<p>To use a local cluster, you just change the <code>start</code> and <code>stop</code> goals to <code>start-cluster</code> and <code>stop-cluster</code> respectively.</p>
<p>Note: On OS-X you will need to enable the local loop back aliases before you can run a cluster. One way to do this is to use the command</p>
<div>
<pre>ifconfig lo0 alias 127.0.0.2</pre></div>
<p>These aliases are not persisted across reboots.</p></section><section>
<h3><a name="Port_usage"></a>Port usage</h3>
<p>As well as the standard Cassandra ports, the Maven plugin also opens a stop port (defaults to 8081) in order to allow the Cassandra service(s) to be shut down cleanly. If the default stop port is used by your tests, or is already in use on your system then you might need to change that default.</p>
<p>The best designed builds will use something like <a class="externalLink" href="http://mojo.codehaus.org/build-helper-maven-plugin/reserve-network-port-mojo.html">build-helper:reserve-network-port</a> to allocate ports.</p></section><section>
<h3><a name="Multi_JVM_use"></a>Multi JVM use</h3>
<p>To use JDK8 with Cassandra Server 3.x in combination with Failsafe integration tests you need to use Toolchains. First we need to configure some Toolchains with Maven. Making the more recent the default for your project. See the <a class="externalLink" href="https://maven.apache.org/guides/mini/guide-using-toolchains.html">Toolchains Plugin</a> for instructions.</p>
<p>Additionally add another execution to Toolchains. To set JDK8 during the maven-failsafe-plugin pre-integration-test phase</p>
<div>
<pre>&lt;plugin&gt;
 &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
 &lt;artifactId&gt;maven-toolchains-plugin&lt;/artifactId&gt;
 &lt;version&gt;3.0.0&lt;/version&gt;
 &lt;executions&gt;
   &lt;execution&gt;
     &lt;id&gt;default-pre-integration-test&lt;/id&gt;
     &lt;phase&gt;pre-integration-test&lt;/phase&gt;
     &lt;goals&gt;
       &lt;goal&gt;toolchain&lt;/goal&gt;
     &lt;/goals&gt;
     &lt;configuration&gt;
       &lt;toolchains&gt;
         &lt;jdk&gt;
           &lt;version&gt;1.8&lt;/version&gt;
           &lt;vendor&gt;OpenJDK&lt;/vendor&gt;
         &lt;/jdk&gt;
       &lt;/toolchains&gt;
     &lt;/configuration&gt;
   &lt;/execution&gt;
 &lt;/executions&gt;
&lt;/plugin&gt;</pre></div>
<p>Finally override the toolchain assigned during pre-integration-test phase. So that the integration-test phase executes with the intended more recent JDK.</p>
<div>
<pre>&lt;plugin&gt;
 &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;
 &lt;configuration&gt;
   &lt;jvm&gt;/usr/lib/jvm/java-11-openjdk/bin/java&lt;/jvm&gt;
 &lt;/configuration&gt;
&lt;/plugin&gt;</pre></div>
<p>This will result in the following during the lifecycle</p>
<table border="1" class="table table-striped">
<tr class="a">
<td align="left"><b>Phase</b></td>
<td align="left"><b>Goal(s)</b></td>
<td align="left"><b>JDK</b></td></tr>
<tr class="b">
<td align="left">pre-integration-test</td>
<td align="left">cassandra:start</td>
<td align="left">8</td></tr>
<tr class="a">
<td align="left">integration-test</td>
<td align="left">failsafe:integration-test</td>
<td align="left">11</td></tr>
<tr class="b">
<td align="left">post-integration-test</td>
<td align="left">cassandra:stop</td>
<td align="left">8</td></tr>
<tr class="a">
<td align="left">verify</td>
<td align="left">failsafe:verify</td>
<td align="left">11</td></tr></table></section><section>
<h3><a name="Trademarks"></a>Trademarks</h3>
<p>Apache, Apache Maven, Apache Cassandra, Maven, Cassandra and the Apache feather logo are trademarks of The Apache Software Foundation.</p></section></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>&#169;      2011&#x2013;2024
<a href="https://www.mojohaus.org">MojoHaus</a>
</p>
        </div>
      </div>
    </footer>
<script>
	if(anchors) {
	  anchors.add();
	}
</script>
  </body>
</html>